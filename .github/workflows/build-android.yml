name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      app_url:
        description: 'URL to load in WebView'
        required: true
        type: string
      app_name:
        description: 'Application name'
        required: true
        type: string
      package_name:
        description: 'Package name (e.g., com.webtoapp.myapp)'
        required: true
        type: string
      icon_url:
        description: 'Icon URL (optional)'
        required: false
        type: string
      build_id:
        description: 'Build ID for callback'
        required: true
        type: string
      callback_url:
        description: 'Callback URL for build status'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'

      - name: Configure app
        run: |
          # Update app name
          sed -i 's|app_name_placeholder|${{ inputs.app_name }}|g' app/src/main/res/values/strings.xml
          
          # Update package name in build.gradle
          sed -i 's|com.webtoapp.template|${{ inputs.package_name }}|g' app/build.gradle
          
          # Update URL in MainActivity
          sed -i 's|https://example.com|${{ inputs.app_url }}|g' app/src/main/java/com/webtoapp/template/MainActivity.kt
          
          # Update AndroidManifest package
          sed -i 's|com.webtoapp.template|${{ inputs.package_name }}|g' app/src/main/AndroidManifest.xml

      - name: Download and set icon
        if: ${{ inputs.icon_url != '' }}
        run: |
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-mdpi
          curl -L "${{ inputs.icon_url }}" -o app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          curl -L "${{ inputs.icon_url }}" -o app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          curl -L "${{ inputs.icon_url }}" -o app/src/main/res/mipmap-xhdpi/ic_launcher.png
          curl -L "${{ inputs.icon_url }}" -o app/src/main/res/mipmap-hdpi/ic_launcher.png
          curl -L "${{ inputs.icon_url }}" -o app/src/main/res/mipmap-mdpi/ic_launcher.png

      - name: Build APK
        run: gradle assembleDebug

      - name: Build AAB
        run: gradle bundleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-bundle
          path: app/build/outputs/bundle/debug/app-debug.aab

      - name: Get artifact URLs and notify callback
        run: |
          RUN_ID=${{ github.run_id }}
          REPO=${{ github.repository }}
          
          # Notify success
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ inputs.build_id }}",
              "status": "completed",
              "apk_url": "https://github.com/'"$REPO"'/actions/runs/'"$RUN_ID"'/artifacts",
              "aab_url": "https://github.com/'"$REPO"'/actions/runs/'"$RUN_ID"'/artifacts"
            }'

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ inputs.build_id }}",
              "status": "failed",
              "error_message": "Build failed. Check GitHub Actions logs."
            }'
